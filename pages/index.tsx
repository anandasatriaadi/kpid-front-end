import {
  faArrowTrendUp,
  faEquals,
  faNotEqual,
} from "@fortawesome/free-solid-svg-icons";
import { FontAwesomeIcon } from "@fortawesome/react-fontawesome";
import {
  Button,
  Form,
  Input,
  message,
  Modal,
  Progress,
  TimePicker,
  UploadFile,
  UploadProps,
} from "antd";
import Upload, { RcFile } from "antd/lib/upload";
import { AxiosProgressEvent, AxiosRequestConfig } from "axios";
import Head from "next/head";
import { useRouter } from "next/router";
import { ReactElement, useContext, useState } from "react";
import httpRequest from "../common/HttpRequest";
import ChartCard from "../components/ChartCard";
import Layout from "../components/Layout";
import { AuthContext, AuthContextInterface } from "../context/AuthContext";
import { isNilOrEmpty } from "../utils/CommonUtil";
import { chart1 } from "./statistic";
import { NextPageWithLayout } from "./_app";

const Home: NextPageWithLayout = () => {
  const router = useRouter();
  const { isLoggedIn, logout, userData } = useContext(
    AuthContext
  ) as AuthContextInterface;
  const [uploadFile, setUploadFile] = useState<UploadFile>();
  const [uploading, setUploading] = useState<Boolean>(false);
  const [uploadProgressPercent, setUploadProgressPercent] = useState<number>(0);
  const [form] = Form.useForm();

  const uploadProgressHandler = (progress: AxiosProgressEvent) => {
    const { loaded, total } = progress;

    if (total !== undefined) {
      setUploadProgressPercent(Math.floor((loaded * 100) / total));
    }
  };

  const onFinish = (values: any) => {
    console.log(values);
    let form = new FormData();
    for (const key in values) {
      form.append(key, values[key]);
    }

    form.append("video_file", uploadFile as RcFile);

    let formPostConfig: AxiosRequestConfig = {
      onUploadProgress: uploadProgressHandler,
    };

    console.log(form.forEach((value, key) => console.log(key, value)));

    httpRequest.post("/moderation-form", form, formPostConfig).then((res) => {
      if (res.status == 201) {
        message.success(res.data);
        setTimeout(() => {
          router.push("/login");
        }, 200);
      } else {
        message.error(res.data);
      }
    });
  };

  const onFinishFailed = (errorInfo: any) => {
    if (!isLoggedIn) {
      router.push("/login");
    }
    console.log("Failed:", errorInfo);
  };

  const fileDropProps: UploadProps = {
    name: "file",
    maxCount: 1,
    beforeUpload: (file) => {
      if (isLoggedIn) {
        setUploadFile(file);
        return false;
      } else {
        message.error("Anda harus login terlebih dahulu");
        return false;
      }
    },
    onRemove: () => {
      form.resetFields();
      setUploadFile(undefined);
    },
    fileList: uploadFile ? [uploadFile] : [],
  };

  return (
    <>
      <Head>
        <title>Moderasi Video | KPID Jawa Timur</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <div className="flex flex-1 flex-col gap-4">
        <section className="grid grid-cols-2 gap-4">
          <div className="rounded-md bg-white p-6 shadow-custom">
            <h2 className="text-2xl font-semibold capitalize">
              Hai {userData.name}!
            </h2>
            <p className="mb-4 text-lg">
              Selamat datang di Sistem Rekomendasi KPID Jawa Timur!
            </p>
            <p>
              Lorem ipsum, dolor sit amet consectetur adipisicing elit.
              Blanditiis consectetur voluptatum nostrum facere quae commodi,
              culpa recusandae illum ut dolorem.
            </p>
          </div>
          <div className="grid gap-4">
            <div className="gap-4 rounded-md bg-white p-6 shadow-custom">
              <div className="flex">
                <div className="flex-1">
                  <h3 className="">Video Terunggah</h3>
                  <p className="text-2xl font-bold">2048</p>
                </div>
                <div className="my-auto flex h-12 w-12 items-center justify-center rounded-xl bg-green-100">
                  <FontAwesomeIcon
                    icon={faEquals}
                    height="24px"
                    className="text-2xl text-green-500"
                  />
                </div>
              </div>
              <div className="mt-4 flex gap-2 rounded-lg bg-slate-100 p-3.5">
                <span className="flex gap-2 text-green-500">
                  <FontAwesomeIcon icon={faArrowTrendUp} height="24px" /> 25.25%
                </span>{" "}
                dari bulan lalu.
              </div>
            </div>
            <div className="gap-4 rounded-md bg-white p-6 shadow-custom">
              <div className="flex">
                <div className="flex-1">
                  <h3 className="">Video Terdeteksi Melanggar</h3>
                  <p className="text-2xl font-bold">1024</p>
                </div>
                <div className="my-auto flex h-12 w-12 items-center justify-center rounded-xl bg-red-100">
                  <FontAwesomeIcon
                    icon={faNotEqual}
                    height="24px"
                    className="text-2xl text-red-500"
                  />
                </div>
              </div>
              <div className="mt-4 flex gap-2 rounded-lg bg-slate-100 p-3.5">
                <span className="flex gap-2 text-red-500">
                  <FontAwesomeIcon icon={faArrowTrendUp} height="24px" /> 25.25%
                </span>{" "}
                dari bulan lalu.
              </div>
            </div>
          </div>
        </section>
        <section className="flex flex-1 flex-col">
          <div className="relative grow rounded-lg bg-white">
            <ChartCard chartData={chart1} title={chart1.title}></ChartCard>
          </div>
          {/* <div className="flex-1">
          <div
            className={
              (isLoggedIn ? "bg-white" : "bg-slate-100") +
              " flex-1 rounded-xl p-4 shadow-custom"
            }
          >
            <Dragger
              {...fileDropProps}
              accept="video/*"
              disabled={!isLoggedIn}
              className={
                "flex h-80 items-center justify-center rounded-md border-2 border-dashed border-gray-400 bg-transparent"
              }
            >
              <div className="flex flex-col text-lg">
                <div className="flex justify-center">
                  <span>
                    <FontAwesomeIcon
                      icon={faFileVideo}
                      width={"36px"}
                      className={isLoggedIn ? "text-sky-500" : "text-gray-300"}
                    />
                  </span>
                </div>
                <div className="flex justify-center">
                  <Button
                    type="primary"
                    className="mt-2 flex items-center text-lg"
                    disabled={!isLoggedIn}
                    icon={<UploadOutlined />}
                  >
                    Pilih Video
                  </Button>
                </div>
                <span className="mt-2 text-gray-900">
                  {isLoggedIn ? (
                    <p>atau letakkan video anda disini</p>
                  ) : (
                    <>
                      <p>
                        Anda harus{" "}
                        <Link href={"/login"}>
                          <a className="font-bold">login</a>
                        </Link>{" "}
                        terlebih dahulu
                      </p>
                      <div className="text-center text-base">
                        Belum memiliki akun?{" "}
                        <Link href={"/login?tab=register"}>
                          <a className="font-bold">Register</a>
                        </Link>
                      </div>
                    </>
                  )}
                </span>
              </div>
            </Dragger>
          </div>
        </div> */}

          <Modal centered open={!isNilOrEmpty(uploadFile)} footer={null}>
            <Form
              form={form}
              name="moderation_form"
              onFinish={onFinish}
              onFinishFailed={onFinishFailed}
              autoComplete="off"
              layout="vertical"
              className="pt-4"
            >
              <div>
                <Upload {...fileDropProps} accept="video/*"></Upload>
                <Form.Item
                  className="my-4 text-lg"
                  initialValue={""}
                  label="Nama Program"
                  name="program_name"
                  rules={[
                    {
                      required: true,
                      message: "Masukkan nama program",
                    },
                  ]}
                >
                  <Input className="text-lg font-normal" />
                </Form.Item>
                <Form.Item
                  className="my-4 text-lg"
                  initialValue={""}
                  label="Stasiun Televisi"
                  name="station_name"
                  rules={[
                    {
                      required: true,
                      message: "Masukkan stasiun televisi",
                    },
                  ]}
                >
                  <Input className="text-lg font-normal" />
                </Form.Item>
                <Form.Item
                  className="my-4 text-lg"
                  initialValue={""}
                  label="Waktu Mulai"
                  name="start_time"
                  rules={[
                    {
                      required: true,
                      message: "Masukkan waktu mulai",
                    },
                  ]}
                >
                  <TimePicker
                    className="w-full text-lg font-normal"
                    format={"HH:mm"}
                  ></TimePicker>
                </Form.Item>
              </div>

              <Progress percent={uploadProgressPercent} />

              <div className="mt-8 flex justify-end">
                <Button className="text-lg" type="primary" htmlType="submit">
                  Upload
                </Button>
              </div>
            </Form>
          </Modal>
        </section>
      </div>
    </>
  );
};

export default Home;

Home.getLayout = function getLayout(page: ReactElement) {
  return <Layout>{page}</Layout>;
};
